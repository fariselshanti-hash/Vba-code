Sub CheckY_FMECA_MTA_IndentureFix()

    Dim wsMain As Worksheet
    Dim wsFMECA As Worksheet
    Dim wsMTA As Worksheet
    Dim lastRow As Long, fmecaLastRow As Long
    Dim i As Long
    Dim mainID As String
    Dim code As String
    Dim shouldHaveY As Boolean
    Dim hasY As Boolean
    Dim matchCell As Range
    Dim criteriaRow As Long
    Dim missingYList As String
    Dim extraYList As String
    Dim fmecaCodes As Collection
    Dim fmecaCode As String
    Dim trimmedCode As String

    Set wsMain = ThisWorkbook.Sheets("LRU SRA")
    Set wsFMECA = ThisWorkbook.Sheets("FMECA")
    Set wsMTA = ThisWorkbook.Sheets("MTA")
    
    lastRow = wsMain.Cells(wsMain.Rows.Count, "A").End(xlUp).Row
    fmecaLastRow = wsFMECA.Cells(wsFMECA.Rows.Count, "A").End(xlUp).Row

    ' Step 1: Build collection of FMECA codes where E > 0
    Set fmecaCodes = New Collection
    On Error Resume Next
    For i = 2 To fmecaLastRow
        If IsNumeric(wsFMECA.Cells(i, "E").Value) Then
            If wsFMECA.Cells(i, "E").Value > 0 Then
                fmecaCodes.Add wsFMECA.Cells(i, "A").Value
            End If
        End If
    Next i
    On Error GoTo 0

    ' Clear previous highlights
    wsMain.Range("AV2:AV" & lastRow).Interior.ColorIndex = 0
    missingYList = ""
    extraYList = ""

    ' Loop through rows in LRU SRA
    For i = 2 To lastRow
        mainID = wsMain.Cells(i, "A").Value
        code = Trim(wsMain.Cells(i, "B").Value)
        shouldHaveY = False
        hasY = (Trim(UCase(wsMain.Cells(i, "AV").Value)) = "Y")

        ' === CRITERIA 1: Direct match in FMECA with E > 0
        Set matchCell = wsFMECA.Columns("A").Find(What:=code, LookIn:=xlValues, LookAt:=xlWhole)
        If Not matchCell Is Nothing Then
            criteriaRow = matchCell.Row
            If IsNumeric(wsFMECA.Cells(criteriaRow, "E").Value) Then
                If wsFMECA.Cells(criteriaRow, "E").Value > 0 Then
                    shouldHaveY = True
                End If
            End If
        End If

        ' === STEP 2: Check if this code is the trimmed version of any matching FMECA code
        If Not shouldHaveY Then
            For Each fmecaCode In fmecaCodes
                If Len(fmecaCode) >= 3 Then ' Make sure we don't trim too much
                    trimmedCode = Left(fmecaCode, Len(fmecaCode) - 2)
                    If code = trimmedCode Then
                        shouldHaveY = True
                        Exit For
                    End If
                End If
            Next fmecaCode
        End If

        ' === CRITERIA 2: Check MTA match and D starts with "HG"
        Set matchCell = wsMTA.Columns("A").Find(What:=code, LookIn:=xlValues, LookAt:=xlWhole)
        If Not matchCell Is Nothing Then
            criteriaRow = matchCell.Row
            If Left(wsMTA.Cells(criteriaRow, "D").Value, 2) = "HG" Then
                shouldHaveY = True
            End If
        End If

        ' === Final Highlighting and Report
        If shouldHaveY And Not hasY Then
            wsMain.Cells(i, "AV").Interior.Color = RGB(255, 199, 206) ' Red
            missingYList = missingYList & "Row " & i & " (ID: " & mainID & ", Code: " & code & ")" & vbNewLine
        ElseIf Not shouldHaveY And hasY Then
            wsMain.Cells(i, "AV").Interior.Color = RGB(255, 235, 156) ' Yellow
            extraYList = extraYList & "Row " & i & " (ID: " & mainID & ", Code: " & code & ")" & vbNewLine
        End If
    Next i

    ' === Summary Message
    Dim msg As String
    msg = ""

    If missingYList <> "" Then
        msg = msg & "ðŸ”´ Missing 'Y' (should have it):" & vbNewLine & missingYList & vbNewLine
    End If

    If extraYList <> "" Then
        msg = msg & "ðŸŸ¡ Extra 'Y' (should NOT have it):" & vbNewLine & extraYList
    End If

    If msg = "" Then
        MsgBox "âœ… All rows passed the FMECA & MTA check.", vbInformation
    Else
        MsgBox msg, vbExclamation, "Review Results"
    End If

End Sub
